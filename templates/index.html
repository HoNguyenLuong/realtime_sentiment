<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Sentiment Analyzer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --light-color: #f8f9fa;
            --dark-color: #212529;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }

        .app-container {
            max-width: 900px;
            margin: 40px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .app-header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px 20px;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }

        .app-header h1 {
            margin: 0;
            font-weight: 700;
            font-size: 2.2rem;
        }

        .app-header p {
            margin-top: 10px;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .app-body {
            padding: 30px;
        }

        .url-input-container {
            position: relative;
            margin-bottom: 30px;
        }

        .url-input-container i {
            position: absolute;
            left: 15px;
            top: 15px;
            color: #aaa;
            font-size: 20px;
        }

        #youtube_url {
            padding-left: 45px;
            height: 50px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        #youtube_url:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
        }

        .btn-process {
            background: var(--primary-color);
            border: none;
            height: 50px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-process:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }

        #loading {
            display: none;
            text-align: center;
            margin: 30px 0;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 15px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Full-screen loading overlay from the second code */
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.8), rgba(76, 201, 240, 0.8));
            z-index: 9999;
            text-align: center;
            color: white;
            font-size: 1.5rem;
            padding-top: 20%;
        }

        .loading-content {
            display: inline-block;
            text-align: center;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-top: 6px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        #loadingOverlay p {
            font-size: 1.2rem;
            font-weight: 500;
            margin-top: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #result {
            display: {% if result and result.total > 0 %}block{% else %}none{% endif %};
            padding: 20px;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        #result h3 {
            color: var(--dark-color);
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
        }

        #sentimentChart {
            max-width: 100%;
            height: 300px;
            margin: 20px auto;
        }

        .sentiment-summary {
            display: flex;
            justify-content: space-around;
            margin-top: 30px;
            text-align: center;
        }

        .sentiment-item {
            flex: 1;
            padding: 15px;
            margin: 0 10px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
        }

        .positive {
            background-color: #4ade80;
        }

        .negative {
            background-color: #f87171;
        }

        .neutral {
            background-color: #fbbf24;
        }

        .alert {
            border-radius: 10px;
            font-weight: 500;
        }

        .video-preview {
            margin-top: 30px;
            display: {% if youtube_url %}block{% else %}none{% endif %};
            text-align: center;
        }

        .video-preview iframe {
            max-width: 100%;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .video-title {
            margin-top: 15px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .no-comments-message {
            text-align: center;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
            display: {% if result and result.total == 0 %}block{% else %}none{% endif %};
        }

        .video-emotions-link {
            display: {% if youtube_url %}block{% else %}none{% endif %};
            text-align: center;
            margin-top: 20px;
        }

        /* Video frames results styling */
        #video-frames-results {
            margin-top: 30px;
            display: {% if youtube_url %}block{% else %}none{% endif %};
        }

        .frames-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .frames-container {
            max-height: 500px;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            background-color: #fff;
        }

        .frame-card {
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 15px;
            border-left: 5px solid var(--primary-color);
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .frame-card.new {
            border-left: 5px solid #4ade80;
            background-color: #f0fff4;
        }

        .frame-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .frame-id {
            font-weight: 700;
            color: var(--primary-color);
        }

        .frame-time {
            font-size: 0.85rem;
            color: #777;
        }

        .frame-details {
            display: flex;
            margin-top: 10px;
        }

        .frame-faces {
            display: flex;
            align-items: center;
            margin-right: 20px;
        }

        .faces-icon {
            color: var(--primary-color);
            margin-right: 5px;
        }

        .emotions-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .emotion-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .happy {
            background-color: #4ade80;
            color: white;
        }

        .sad {
            background-color: #60a5fa;
            color: white;
        }

        .angry {
            background-color: #f87171;
            color: white;
        }

        .surprise {
            background-color: #fbbf24;
            color: white;
        }

        .fear {
            background-color: #a78bfa;
            color: white;
        }

        .neutral {
            background-color: #9ca3af;
            color: white;
        }

        .disgusted {
            background-color: #10b981;
            color: white;
        }

        .no-frames-message {
            text-align: center;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .app-container {
                margin: 20px;
                border-radius: 15px;
            }

            .app-header {
                padding: 20px;
            }

            .app-body {
                padding: 20px;
            }

            .sentiment-summary {
                flex-direction: column;
            }

            .sentiment-item {
                margin: 5px 0;
            }

            .frame-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .frame-time {
                margin-top: 5px;
            }
        }
        .audio-card {
        margin-bottom: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        padding: 15px;
        border-left: 5px solid #7c4dff; /* Màu khác với video để phân biệt */
        animation: fadeIn 0.5s;
        }

        .audio-card.new {
            border-left: 5px solid #e040fb;
            background-color: #f3e5f5;
        }

        .audio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .chunk-id {
            font-weight: 700;
            color: #7c4dff;
        }

        .audio-time {
            font-size: 0.85rem;
            color: #777;
        }

        .audio-text {
            margin: 10px 0;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 8px;
            font-style: italic;
        }

        /* Thêm màu cho các loại cảm xúc audio */
        .sentiment-joy {
            background-color: #4ade80;
            color: white;
        }

        .sentiment-sadness {
            background-color: #60a5fa;
            color: white;
        }

        .sentiment-anger {
            background-color: #f87171;
            color: white;
        }

        .sentiment-fear {
            background-color: #a78bfa;
            color: white;
        }

        /* Styles for fusion section */
        .fusion-container {
            max-height: 500px;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            background-color: #fff;
            padding: 20px;
        }

        .border-left-primary {
            border-left: 5px solid var(--primary-color);
        }

        .fusion-summary {
            margin-top: 20px;
        }

        /* Radar chart container */
        .fusion-chart-container {
            margin: 20px auto;
            max-width: 100%;
        }

        /* Timeline visualization */
        .fusion-timeline {
            position: relative;
            margin: 30px 0;
            padding: 20px 0;
        }

        .fusion-timeline:before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            height: 100%;
            width: 4px;
            background: var(--primary-color);
            opacity: 0.3;
        }

        .fusion-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            position: relative;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .fusion-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .fusion-time {
            display: inline-block;
            padding: 5px 10px;
            background: var(--primary-color);
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        /* Hiển thị layout hai cột khi màn hình rộng */
        @media (min-width: 992px) {
            .results-container {
                display: flex;
                gap: 20px;
            }

            #video-frames-results,
            #audio-results {
                flex: 1;
                min-width: 0; /* Giúp flex items không bị overflow */
            }
        }
    </style>
</head>
<body>
    <!-- Full-screen loading overlay -->
    <div id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Processing YouTube video... Please wait</p>
        </div>
    </div>

    <div class="app-container">
        <div class="app-header">
            <h1><i class="fab fa-youtube"></i> YouTube Sentiment Analyzer</h1>
            <p>Analyze the sentiment of comments on any YouTube video</p>
        </div>

        <div class="app-body">
            <!-- Messages from server (replacing Flash messages) -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.category }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{% if message.category == 'success' %}check-circle{% elif message.category == 'danger' %}exclamation-circle{% else %}info-circle{% endif %} me-2"></i>
                        {{ message.message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <form id="youtubeForm" method="POST" action="/">
                <div class="url-input-container">
                    <i class="fas fa-link"></i>
                    <input type="url" class="form-control" id="youtube_url" name="youtube_url"
                           placeholder="Paste YouTube URL here (e.g., https://www.youtube.com/watch?v=example)"
                           value="{{ youtube_url or '' }}" required>
                </div>
                <button type="submit" class="btn btn-primary btn-process w-100">
                    <i class="fas fa-chart-pie me-2"></i> Analyze Sentiment
                </button>
            </form>

            <!-- Alert messages for non-flash errors -->
            {% if error %}
            <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                {{ error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            <!-- Loading indicator (in-page) -->
            <div id="loading">
                <div class="loading-spinner"></div>
                <p>Analyzing comments... This may take a few moments</p>
            </div>

            <!-- Video preview -->
            <div class="video-preview" id="videoPreview">
                {% if youtube_url %}
                <iframe id="videoIframe" width="560" height="315" src="https://www.youtube.com/embed/{{ youtube_url.split('v=')[1].split('&')[0] if 'v=' in youtube_url else youtube_url.split('/')[-1] }}" frameborder="0" allowfullscreen></iframe>
                <div class="video-title" id="videoTitle">Video Analysis</div>
                {% endif %}
            </div>

            <!-- Link to video emotions analysis page -->
            <div class="video-emotions-link">
                <a href="/video_emotions" class="btn btn-outline-primary">
                    <i class="fas fa-film me-2"></i> View Video Frame Emotions Analysis
                </a>
            </div>

            <!-- No comments message -->
            <div class="no-comments-message" id="noCommentsMessage">
                <i class="fas fa-info-circle fa-2x mb-3 text-primary"></i>
                <h4>No Comments Analyzed</h4>
                <p>Either the video has no comments or we're still processing them. Try another video or check back later.</p>
            </div>

            <!-- Results section -->
            <div id="result" class="mt-4">
                <h3>Comment Sentiment Analysis Results</h3>
                <canvas id="sentimentChart"></canvas>

                <div class="sentiment-summary">
                    <div class="sentiment-item positive">
                        <i class="fas fa-smile-beam mb-2" style="font-size: 24px;"></i>
                        <div>Positive</div>
                        <div id="positivePercentage" style="font-size: 20px;">
                            {% if result and result.total > 0 %}
                            {{ ((result.positive / result.total) * 100) | round | int }}%
                            {% else %}
                            0%
                            {% endif %}
                        </div>
                    </div>
                    <div class="sentiment-item negative">
                        <i class="fas fa-angry mb-2" style="font-size: 24px;"></i>
                        <div>Negative</div>
                        <div id="negativePercentage" style="font-size: 20px;">
                            {% if result and result.total > 0 %}
                            {{ ((result.negative / result.total) * 100) | round | int }}%
                            {% else %}
                            0%
                            {% endif %}
                        </div>
                    </div>
                    <div class="sentiment-item neutral">
                        <i class="fas fa-meh mb-2" style="font-size: 24px;"></i>
                        <div>Neutral</div>
                        <div id="neutralPercentage" style="font-size: 20px;">
                            {% if result and result.total > 0 %}
                            {{ ((result.neutral / result.total) * 100) | round | int }}%
                            {% else %}
                            0%
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="results-container">
                <!-- Video Frames Results Section -->
                <div id="video-frames-results" class="mt-4">
                    <!-- Nội dung hiện tại -->
                </div>

                <!-- Audio Results Section -->
                <div id="audio-results" class="mt-4">
                    <!-- Nội dung như trên đã thêm -->
                </div>

                <!-- Final Results Section -->
                <div id="final-results" class="mt-4">
                    <!-- Nội dung như trên đã thêm -->
                </div>
            </div>

            <!-- Video Frames Results Section -->
            <div id="video-frames-results" class="mt-4">
                <div class="frames-header">
                    <h3>Video Frame Sentiment Analysis</h3>
                    <p class="text-muted">Showing real-time frame analysis results</p>
                </div>

                <div class="frames-container" id="framesContainer">
                    <div class="no-frames-message" id="noFramesMessage">
                        <i class="fas fa-film fa-2x mb-3 text-primary"></i>
                        <h4>No Frame Analysis Yet</h4>
                        <p>Frame analysis will appear here once processing begins</p>
                    </div>
                </div>
            </div>

            <div id="audio-results" class="mt-4">
                <div class="frames-header">
                    <h3>Audio Sentiment Analysis</h3>
                    <p class="text-muted">Showing real-time audio analysis results</p>
                </div>

                <div class="frames-container" id="audioContainer">
                    <div class="no-frames-message" id="noAudioMessage">
                        <i class="fas fa-volume-up fa-2x mb-3 text-primary"></i>
                        <h4>No Audio Analysis Yet</h4>
                        <p>Audio analysis will appear here once processing begins</p>
                    </div>
                </div>
            </div>

            <div id="fusion-results" class="mt-4">
                <div class="frames-header">
                    <h3>Fusion Analysis Results</h3>
                    <p class="text-muted">Combined analysis from comments, video, and audio</p>
                </div>

                <div class="fusion-container" id="fusionContainer">
                    <div class="no-frames-message" id="noFusionMessage">
                        <i class="fas fa-layer-group fa-2x mb-3 text-primary"></i>
                        <h4>No Fusion Analysis Yet</h4>
                        <p>Combined analysis will appear here once processing is complete</p>
                    </div>

                    <!-- Fusion summary card -->
                    <div id="fusionSummaryCard" style="display: none;" class="mb-4 p-4 border-left-primary rounded shadow-sm">
                        <h4 class="mb-3">Overall Sentiment</h4>
                        <div class="fusion-chart-container" style="height: 300px;">
                            <canvas id="fusionChart"></canvas>
                        </div>
                        <div class="fusion-summary mt-3">
                            <div class="alert alert-primary" role="alert">
                                <i class="fas fa-info-circle me-2"></i>
                                <span id="fusionConclusion">Analysis in progress...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        const form = document.getElementById('youtubeForm');
        const loadingDiv = document.getElementById('loading');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const resultDiv = document.getElementById('result');
        const videoPreview = document.getElementById('videoPreview');
        const noCommentsMessage = document.getElementById('noCommentsMessage');
        const framesContainer = document.getElementById('framesContainer');
        const noFramesMessage = document.getElementById('noFramesMessage');
        const videoFramesResults = document.getElementById('video-frames-results');

        // Track processed frames to avoid duplicates
        const processedFrames = new Set();
        const processedAudioChunks = new Set();
        let lastFrameCount = 0;

        {% if result %}
        // If we have results, initialize the chart
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('sentimentChart').getContext('2d');

            // Check if we have any data to display
            const total = {{ result.total | default(0) }};

            if (total > 0) {
                window.sentimentChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Positive', 'Negative', 'Neutral'],
                        datasets: [{
                            label: 'Comment Sentiment Distribution',
                            data: [
                                {{ result.positive | default(0) }},
                                {{ result.negative | default(0) }},
                                {{ result.neutral | default(0) }}
                            ],
                            backgroundColor: ['#4ade80', '#f87171', '#fbbf24'],
                            borderColor: ['#4ade80', '#f87171', '#fbbf24'],
                            borderWidth: 1,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 14
                                },
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            const total = {{ result.total | default(1) }};
                                            const percentage = Math.round((context.parsed.y / total) * 100);
                                            label += `${context.parsed.y} comments (${percentage}%)`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Comments',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                ticks: {
                                    precision: 0
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Sentiment Category',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            }
                        }
                    }
                });

                // Show results and hide no comments message
                resultDiv.style.display = 'block';
                noCommentsMessage.style.display = 'none';
            } else {
                // Show no comments message and hide results
                resultDiv.style.display = 'none';
                noCommentsMessage.style.display = 'block';
            }
        });
        {% endif %}

        // Show loading animation when form is submitted
        form.addEventListener('submit', function() {
            // Show the fullscreen loading overlay instead of the in-page loader
            loadingOverlay.style.display = 'block';
            resultDiv.style.display = 'none';
            noCommentsMessage.style.display = 'none';
        });

        // Function to extract YouTube video ID from URL
        function getYoutubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // Helper function to create emotion badges
        function createEmotionBadges(emotions) {
            let badgesHTML = '';

            if (!emotions) return badgesHTML;

            // Map emotion names to appropriate classes
            const emotionClasses = {
                'happy': 'happy',
                'sad': 'sad',
                'angry': 'angry',
                'surprise': 'surprise',
                'fear': 'fear',
                'neutral': 'neutral',
                'disgust': 'disgusted'
            };

            // Process each emotion in the object
            for (const [emotion, value] of Object.entries(emotions)) {
                if (value > 0) {
                    const className = emotionClasses[emotion.toLowerCase()] || 'neutral';
                    badgesHTML += `<span class="emotion-badge ${className}">${emotion}: ${value}</span>`;
                }
            }

            return badgesHTML;
        }

        // Function to create a frame card
        function createFrameCard(frame, isNew = false) {
            return `
                <div class="frame-card ${isNew ? 'new' : ''}" id="frame-${frame.frame_id}">
                    <div class="frame-header">
                        <div class="frame-id">Frame #${frame.frame_id}</div>
                        <div class="frame-time">
                            <i class="far fa-clock me-1"></i> Processed at: ${frame.processed_at}
                        </div>
                    </div>
                    <div class="frame-details">
                        <div class="frame-faces">
                            <i class="fas fa-user faces-icon"></i>
                            <span>${frame.num_faces} face${frame.num_faces !== 1 ? 's' : ''} detected</span>
                        </div>
                        <div class="emotions-badges">
                            ${createEmotionBadges(frame.emotions)}
                        </div>
                    </div>
                </div>
            `;
        }

        // Function to update video frames results
        function updateVideoFrames() {
            fetch('/api/get_video_sentiments')
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        // Hide the no frames message
                        noFramesMessage.style.display = 'none';

                        // Check if we have new frames
                        const newFrames = data.filter(frame => !processedFrames.has(frame.frame_id));

                        if (newFrames.length > 0) {
                            // Update our set of processed frames
                            newFrames.forEach(frame => processedFrames.add(frame.frame_id));

                            // Sort newest first
                            newFrames.sort((a, b) => {
                                return new Date(b.processed_at) - new Date(a.processed_at);
                            });

                            // Create HTML for new frames
                            let newFramesHTML = '';
                            newFrames.forEach(frame => {
                                newFramesHTML += createFrameCard(frame, true);
                            });

                            // Insert at the beginning of the container
                            if (framesContainer.innerHTML === noFramesMessage.outerHTML) {
                                framesContainer.innerHTML = newFramesHTML;
                            } else {
                                framesContainer.insertAdjacentHTML('afterbegin', newFramesHTML);
                            }

                            // After a second, remove the 'new' class from the new cards
                            setTimeout(() => {
                                newFrames.forEach(frame => {
                                    const frameElement = document.getElementById(`frame-${frame.frame_id}`);
                                    if (frameElement) {
                                        frameElement.classList.remove('new');
                                    }
                                });
                            }, 1000);
                        }
                    }
                })
                .catch(error => console.error('Error updating video frames:', error));
        }

        // Add real-time update for comment sentiment
        {% if youtube_url %}
        // Only run this if we have a YouTube URL
        let updateInterval;
        let framesUpdateInterval;

        function updateSentimentData() {
            fetch('/api/get_results')
                .then(response => response.json())
                .then(data => {
                    // Hide loading overlay once we have data
                    loadingOverlay.style.display = 'none';

                    // Update chart if it exists
                    if (window.sentimentChart) {
                        window.sentimentChart.data.datasets[0].data = [
                            data.positive,
                            data.negative,
                            data.neutral
                        ];
                        window.sentimentChart.update();
                    }

                    // Update percentages
                    const total = data.positive + data.negative + data.neutral;
                    if (total > 0) {
                        document.getElementById('positivePercentage').textContent =
                            Math.round((data.positive / total) * 100) + '%';
                        document.getElementById('negativePercentage').textContent =
                            Math.round((data.negative / total) * 100) + '%';
                        document.getElementById('neutralPercentage').textContent =
                            Math.round((data.neutral / total) * 100) + '%';

                        // Show results if we have data
                        resultDiv.style.display = 'block';
                        noCommentsMessage.style.display = 'none';
                    } else {
                        // No comments yet
                        resultDiv.style.display = 'none';
                        noCommentsMessage.style.display = 'block';
                    }
                })
                .catch(error => console.error('Error updating sentiment data:', error));
        }

        // Function để tạo một audio card
        function createAudioCard(audio, isNew = false) {
            // Tạo badges cho sentiment
            let sentimentBadges = '';
            if (audio.sentiment) {
                for (const [sentiment, value] of Object.entries(audio.sentiment)) {
                    if (value > 0) {
                        const className = `sentiment-${sentiment.toLowerCase()}`;
                        sentimentBadges += `<span class="emotion-badge ${className}">${sentiment}: ${value}</span>`;
                    }
                }
            }

            // Tạo badges cho emotion
            let emotionBadges = '';
            if (audio.emotion) {
                for (const [emotion, value] of Object.entries(audio.emotion)) {
                    if (value > 0) {
                        // Sử dụng lại classes từ emotion video
                        const emotionClass = mapEmotionToClass(emotion);
                        emotionBadges += `<span class="emotion-badge ${emotionClass}">${emotion}: ${value}</span>`;
                    }
                }
            }

            return `
                <div class="audio-card ${isNew ? 'new' : ''}" id="audio-${audio.chunk_id}">
                    <div class="audio-header">
                        <div class="chunk-id">Chunk #${audio.chunk_id}</div>
                        <div class="audio-time">
                            <i class="far fa-clock me-1"></i> Processed at: ${audio.processed_at}
                        </div>
                    </div>
                    <div class="audio-text">"${audio.text}"</div>
                    <div class="frame-details">
                        <div class="emotions-badges">
                            ${sentimentBadges}
                            ${emotionBadges}
                        </div>
                    </div>
                </div>
            `;
        }

        // Mapping emotion names to CSS classes
        function mapEmotionToClass(emotion) {
            const map = {
                'happy': 'happy',
                'joy': 'happy',
                'sad': 'sad',
                'sadness': 'sad',
                'angry': 'angry',
                'anger': 'angry',
                'surprise': 'surprise',
                'fear': 'fear',
                'neutral': 'neutral',
                'disgust': 'disgusted'
            };

            return map[emotion.toLowerCase()] || 'neutral';
        }

        // Function to update audio results
        function updateAudioResults() {
            fetch('/api/get_audio_sentiments')
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        // Hide the no audio message
                        document.getElementById('noAudioMessage').style.display = 'none';

                        // Check if we have new audio chunks
                        const newAudioChunks = data.filter(chunk => !processedAudioChunks.has(chunk.chunk_id));

                        if (newAudioChunks.length > 0) {
                            // Update our set of processed chunks
                            newAudioChunks.forEach(chunk => processedAudioChunks.add(chunk.chunk_id));

                            // Sort newest first
                            newAudioChunks.sort((a, b) => {
                                return new Date(b.processed_at) - new Date(a.processed_at);
                            });

                            // Create HTML for new chunks
                            let newAudioHTML = '';
                            newAudioChunks.forEach(chunk => {
                                newAudioHTML += createAudioCard(chunk, true);
                            });

                            // Insert at the beginning of the container
                            const audioContainer = document.getElementById('audioContainer');
                            if (audioContainer.innerHTML === document.getElementById('noAudioMessage').outerHTML) {
                                audioContainer.innerHTML = newAudioHTML;
                            } else {
                                audioContainer.insertAdjacentHTML('afterbegin', newAudioHTML);
                            }

                            // After a second, remove the 'new' class
                            setTimeout(() => {
                                newAudioChunks.forEach(chunk => {
                                    const audioElement = document.getElementById(`audio-${chunk.chunk_id}`);
                                    if (audioElement) {
                                        audioElement.classList.remove('new');
                                    }
                                });
                            }, 1000);
                        }
                    }
                })
                .catch(error => console.error('Error updating audio results:', error));
        }
        // Start polling for updates every 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            updateSentimentData(); // Initial update for comments
            updateVideoFrames();   // Initial update for video frames
            updateAudioResults();  // Initial update for audio results

            updateInterval = setInterval(updateSentimentData, 5000);
            framesUpdateInterval = setInterval(updateVideoFrames, 3000); // Check for new frames every 3 seconds
            audioUpdateInterval = setInterval(updateAudioResults, 3000); // Check for new audio every 3 seconds

            // Make sure results sections are visible
            document.getElementById('video-frames-results').style.display = 'block';
            document.getElementById('audio-results').style.display = 'block';
        });

        // Update cleanup event to include audio interval
        window.addEventListener('beforeunload', function() {
            clearInterval(updateInterval);
            clearInterval(framesUpdateInterval);
            clearInterval(audioUpdateInterval);
        });
        {% endif %}

        // Function to update fusion results
        function updateFusionResults() {
            fetch('/api/final')
                    .then(response => response.json())
                    .then(data => {
                        if (data && Object.keys(data).length > 0) {
                            // Hide the no fusion message
                            document.getElementById('noFusionMessage').style.display = 'none';

                            // Show the fusion summary card
                            const summaryCard = document.getElementById('fusionSummaryCard');
                            summaryCard.style.display = 'block';

                            // Update the fusion conclusion
                            if (data.conclusion) {
                                document.getElementById('fusionConclusion').textContent = data.conclusion;
                            }

                            // Update or create fusion chart
                            updateFusionChart(data);
                        }
                    })
                    .catch(error => console.error('Error updating fusion results:', error));
        }

        // Function to create/update the fusion chart
        function updateFusionChart(data) {
            const ctx = document.getElementById('fusionChart').getContext('2d');

            // If chart exists, destroy it before recreating
            if (window.fusionChart) {
                window.fusionChart.destroy();
            }

            // Extract data for the chart
            const labels = Object.keys(data.emotions || {});
            const values = Object.values(data.emotions || {});

            // Create radar chart
            window.fusionChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Combined Sentiment Analysis',
                        data: values,
                        backgroundColor: 'rgba(67, 97, 238, 0.2)',
                        borderColor: 'rgba(67, 97, 238, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(67, 97, 238, 1)',
                        pointRadius: 4
                    }]
                },
                options: {
                    scales: {
                        r: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 0.2
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.r !== null) {
                                        label += (context.parsed.r * 100).toFixed(1) + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Add the fusion update to the existing interval setup
        {%
            if youtube_url %
        }
        document.addEventListener('DOMContentLoaded', function () {
            // Add this line to your existing DOMContentLoaded function
            updateFusionResults(); // Initial update for fusion results

            // Add this line to your existing intervals
            fusionUpdateInterval = setInterval(updateFusionResults, 5000); // Check for fusion updates every 5 seconds

            // Add this to your existing beforeunload event listener
            window.addEventListener('beforeunload', function () {
                // Add this line to the existing clearInterval calls
                clearInterval(fusionUpdateInterval);
            });
        });
        {%
            endif %
        }
    </script>
</body>
</html>